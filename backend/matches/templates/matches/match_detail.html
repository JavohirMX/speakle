{% extends 'base.html' %}

{% block title %}{{ partner.username }} - Match Details - Speakle{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <!-- Back Button -->
    <div class="mb-6">
        <a href="{% url 'matches:my_matches' %}" 
           class="inline-flex items-center text-blue-600 hover:text-blue-800 transition">
            ‚Üê Back to My Matches
        </a>
        
        <!-- Testing: Online Status Toggle -->
        <div class="float-right">
            <button id="statusToggle" onclick="toggleOnlineStatus()" 
                    class="bg-gray-500 text-white px-3 py-1 rounded-full text-sm hover:bg-gray-600 transition">
                üîò Set Online
            </button>
            <span id="currentStatus" class="ml-2 text-sm text-gray-600">Status: Unknown</span>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-8">
        <!-- Partner Header -->
        <div class="flex items-center mb-8">
            {% if partner.profile_picture %}
                <img src="{{ partner.profile_picture.url }}" 
                     alt="{{ partner.username }}" 
                     class="w-24 h-24 rounded-full object-cover mr-6">
            {% else %}
                <div class="w-24 h-24 rounded-full bg-purple-500 flex items-center justify-center text-white font-bold text-3xl mr-6">
                    {{ partner.username|first|upper }}
                </div>
            {% endif %}
            <div class="flex-1">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ partner.username }}</h1>
                <div class="flex items-center space-x-4 text-sm text-gray-600 mb-3">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        ‚úÖ Active Match
                    </span>
                    <span>Matched {{ match.created_at|timesince }} ago</span>
                </div>
                
                <!-- Quick Action Buttons -->
                <div class="space-y-3">
                    <button onclick="initiateVideoCall({{ match.id }})"
                           class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition flex items-center justify-center w-full">
                        üé• Start Video Chat
                    </button>
                    
                    <!-- Quick Join Button (if room exists) -->
                    {% if match.video_room %}
                    <div class="flex space-x-2">
                        <a href="{% url 'chats:video_room' match.video_room.room_id %}"
                           class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition text-sm text-center">
                            ‚ö° Quick Join Room
                        </a>
                        <a href="{% url 'chats:call_history' match.video_room.room_id %}" 
                           class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition text-sm text-center">
                            üìä Call History
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Language Exchange Section -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Language Exchange</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-blue-50 rounded-lg p-6">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">{{ user_teaches.flag_emoji }}</div>
                        <h3 class="text-lg font-semibold text-blue-700">You Teach</h3>
                        <p class="text-2xl font-bold text-blue-600">{{ user_teaches.name }}</p>
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                        {% for user_lang in user.userlanguage_set.all %}
                            {% if user_lang.language == user_teaches %}
                                <p><strong>Your Level:</strong> {{ user_lang.get_proficiency_display }} ({{ user_lang.get_language_type_display }})</p>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
                <div class="bg-green-50 rounded-lg p-6">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">{{ user_learns.flag_emoji }}</div>
                        <h3 class="text-lg font-semibold text-green-700">You Learn</h3>
                        <p class="text-2xl font-bold text-green-600">{{ user_learns.name }}</p>
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                        {% for user_lang in user.userlanguage_set.all %}
                            {% if user_lang.language == user_learns %}
                                <p><strong>Your Level:</strong> {{ user_lang.get_proficiency_display }}</p>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Partner's Languages -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">{{ partner.username }}'s Languages</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                {% for user_lang in partner.userlanguage_set.all %}
                    <div class="border rounded-lg p-4 text-center">
                        <div class="text-2xl mb-2">{{ user_lang.language.flag_emoji }}</div>
                        <h3 class="font-semibold text-gray-900">{{ user_lang.language.name }}</h3>
                        <p class="text-sm text-gray-600">{{ user_lang.get_proficiency_display }}</p>
                        <span class="inline-block mt-2 px-2 py-1 text-xs rounded-full
                            {% if user_lang.language_type == 'native' %}bg-red-100 text-red-800
                            {% elif user_lang.language_type == 'fluent' %}bg-blue-100 text-blue-800
                            {% else %}bg-green-100 text-green-800{% endif %}">
                            {{ user_lang.get_language_type_display }}
                        </span>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Partner's Profile -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Bio -->
            {% if partner.bio %}
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">About {{ partner.username }}</h2>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-gray-700 leading-relaxed">{{ partner.bio }}</p>
                    </div>
                </div>
            {% endif %}

            <!-- Interests -->
            {% if partner.interests %}
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Interests</h2>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-gray-700 leading-relaxed">{{ partner.interests }}</p>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Learning Tips Section -->
        <div class="mt-8 bg-yellow-50 rounded-lg p-6">
            <h2 class="text-lg font-semibold text-yellow-800 mb-3">üí° Language Exchange Tips</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-yellow-700">
                <div>
                    <h3 class="font-medium mb-2">For {{ user_teaches.name }} practice:</h3>
                    <ul class="space-y-1">
                        <li>‚Ä¢ Start with basic conversations</li>
                        <li>‚Ä¢ Focus on pronunciation</li>
                        <li>‚Ä¢ Use everyday vocabulary</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-medium mb-2">For {{ user_learns.name }} learning:</h3>
                    <ul class="space-y-1">
                        <li>‚Ä¢ Don't be afraid to make mistakes</li>
                        <li>‚Ä¢ Ask for corrections</li>
                        <li>‚Ä¢ Practice regularly</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Match Statistics -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
            <div class="bg-blue-50 rounded-lg p-4">
                <div class="text-2xl font-bold text-blue-600">{{ match.created_at|timesince }}</div>
                <p class="text-sm text-blue-800">Time since match</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4">
                <div class="text-2xl font-bold text-green-600">
                    {% if match.video_room %}
                        {{ match.video_room.sessions.count }}
                    {% else %}
                        0
                    {% endif %}
                </div>
                <p class="text-sm text-green-800">Video sessions</p>
            </div>
            <div class="bg-purple-50 rounded-lg p-4">
                <div class="text-2xl font-bold text-purple-600">Active</div>
                <p class="text-sm text-purple-800">Match status</p>
            </div>
        </div>
    </div>
</div>

<!-- Call Invitation Modal -->
<div id="callInvitationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-lg font-semibold mb-4">üìû Start Video Call</h3>
            
            <!-- Partner Status -->
            <div id="partnerStatus" class="mb-4 p-3 rounded-lg border">
                <div class="flex items-center">
                    <div id="statusIndicator" class="w-3 h-3 rounded-full mr-2"></div>
                    <span id="statusText">Checking {{ partner.username }}'s availability...</span>
                </div>
            </div>
            
            <!-- Call invitation form -->
            <div id="invitationForm" style="display: none;">
                <div class="mb-4">
                    <label for="callMessage" class="block text-sm font-medium text-gray-700 mb-2">
                        Optional message (will be sent with invitation):
                    </label>
                    <textarea id="callMessage" rows="3" 
                              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Hey! Want to practice some language exchange?"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button onclick="closeCallModal()" 
                            class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition">
                        Cancel
                    </button>
                    <button onclick="sendCallInvitation()" 
                            class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                        üìû Send Invitation
                    </button>
                </div>
            </div>
            
            <!-- Waiting for response -->
            <div id="waitingResponse" style="display: none;">
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>
                    <p class="text-gray-600 mb-4">Invitation sent! Waiting for {{ partner.username }} to respond...</p>
                    <div class="text-sm text-gray-500 mb-4">
                        Invitation expires in <span id="timeRemaining">2:00</span>
                    </div>
                    <button onclick="cancelInvitation()" 
                            class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition">
                        Cancel Invitation
                    </button>
                </div>
            </div>
            
            <!-- Offline message -->
            <div id="offlineMessage" style="display: none;">
                <p class="text-gray-600 mb-4">{{ partner.username }} is currently offline.</p>
                <div class="text-sm text-gray-500 mb-4">
                    Last seen: <span id="lastSeenTime"></span>
                </div>
                <div class="flex justify-end space-x-2">
                    <button onclick="closeCallModal()" 
                            class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition">
                        Close
                    </button>
                    <a href="{% url 'chats:create_room' match.id %}" 
                       class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                        Enter Room Anyway
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentMatchId = null;
let currentInvitationId = null;
let invitationTimer = null;
let statusCheckInterval = null;

function initiateVideoCall(matchId) {
    currentMatchId = matchId;
    document.getElementById('callInvitationModal').classList.remove('hidden');
    
    // Reset modal state
    document.getElementById('invitationForm').style.display = 'none';
    document.getElementById('waitingResponse').style.display = 'none';
    document.getElementById('offlineMessage').style.display = 'none';
    
    // Check partner availability
    checkPartnerAvailability();
}

function checkPartnerAvailability() {
    // Actually check partner availability via API
    fetch(`/chats/api/partner-availability/${currentMatchId}/`)
    .then(response => response.json())
    .then(data => {
        if (data.is_online) {
            showPartnerOnline();
        } else {
            showPartnerOffline(data.last_seen);
        }
    })
    .catch(error => {
        console.error('Error checking partner availability:', error);
        // Default to showing offline if API fails
        showPartnerOffline();
    });
}

function showPartnerOnline() {
    const indicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    
    indicator.className = 'w-3 h-3 rounded-full mr-2 bg-green-500';
    statusText.textContent = '{{ partner.username }} is online';
    
    setTimeout(() => {
        document.getElementById('invitationForm').style.display = 'block';
    }, 500);
}

function showPartnerOffline(lastSeen) {
    const indicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    
    indicator.className = 'w-3 h-3 rounded-full mr-2 bg-gray-400';
    statusText.textContent = '{{ partner.username }} is offline';
    
    if (lastSeen) {
        document.getElementById('lastSeenTime').textContent = new Date(lastSeen).toLocaleString();
    }
    
    setTimeout(() => {
        document.getElementById('offlineMessage').style.display = 'block';
    }, 500);
}

function sendCallInvitation() {
    const message = document.getElementById('callMessage').value;
    const formData = new FormData();
    formData.append('message', message);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/chats/invite/${currentMatchId}/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentInvitationId = data.invitation_id;
            showWaitingForResponse();
            startInvitationTimer();
            startStatusPolling();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error sending invitation:', error);
        alert('Failed to send invitation. Please try again.');
    });
}

function showWaitingForResponse() {
    document.getElementById('invitationForm').style.display = 'none';
    document.getElementById('waitingResponse').style.display = 'block';
}

function startInvitationTimer() {
    let timeLeft = 120; // 2 minutes in seconds
    const timeDisplay = document.getElementById('timeRemaining');
    
    invitationTimer = setInterval(() => {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        timeLeft--;
        
        if (timeLeft < 0) {
            clearInterval(invitationTimer);
            invitationExpired();
        }
    }, 1000);
}

function startStatusPolling() {
    statusCheckInterval = setInterval(() => {
        if (currentInvitationId) {
            fetch(`/chats/invitation/${currentInvitationId}/status/`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'accepted') {
                    clearInterval(statusCheckInterval);
                    clearInterval(invitationTimer);
                    invitationAccepted();
                } else if (data.status === 'declined') {
                    clearInterval(statusCheckInterval);
                    clearInterval(invitationTimer);
                    invitationDeclined();
                } else if (data.is_expired) {
                    clearInterval(statusCheckInterval);
                    clearInterval(invitationTimer);
                    invitationExpired();
                }
            })
            .catch(error => console.error('Error checking status:', error));
        }
    }, 5000); // Check every 5 seconds since we have WebSocket notifications for faster updates
}

function invitationAccepted() {
    closeCallModal();
    if (typeof showNotificationToast === 'function') {
        showNotificationToast('Call Accepted!', '{{ partner.username }} accepted your call! Redirecting...', '‚úÖ');
    }
    // Note: Redirection will be handled by the global notification system
    // The global WebSocket listener will receive the call_invitation_accepted event
    // and redirect to the correct room URL automatically
}

function invitationDeclined() {
    closeCallModal();
    if (typeof showNotificationToast === 'function') {
        showNotificationToast('Call Declined', '{{ partner.username }} declined your call invitation.', '‚ùå');
    } else {
        alert('{{ partner.username }} declined your call invitation.');
    }
}

function invitationExpired() {
    closeCallModal();
    if (typeof showNotificationToast === 'function') {
        showNotificationToast('Call Expired', 'Call invitation expired. {{ partner.username }} did not respond in time.', '‚è∞');
    } else {
        alert('Call invitation expired. {{ partner.username }} did not respond in time.');
    }
}

function cancelInvitation() {
    if (currentInvitationId) {
        // Call API endpoint to cancel invitation
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch(`/chats/invitation/${currentInvitationId}/cancel/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Invitation cancelled successfully');
            } else {
                console.error('Failed to cancel invitation:', data.error);
            }
        })
        .catch(error => {
            console.error('Error cancelling invitation:', error);
        });
        
        clearInterval(invitationTimer);
        clearInterval(statusCheckInterval);
    }
    closeCallModal();
}

function closeCallModal() {
    document.getElementById('callInvitationModal').classList.add('hidden');
    if (invitationTimer) clearInterval(invitationTimer);
    if (statusCheckInterval) clearInterval(statusCheckInterval);
    currentInvitationId = null;
    currentMatchId = null;
}

// Initialize and check current online status
let isCurrentlyOnline = false;

function toggleOnlineStatus() {
    const newStatus = !isCurrentlyOnline;
    const formData = new FormData();
    formData.append('is_online', newStatus.toString());
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('/chats/api/set-online-status/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            isCurrentlyOnline = data.is_online;
            updateStatusUI();
        } else {
            alert('Failed to update status');
        }
    })
    .catch(error => {
        console.error('Error updating status:', error);
        alert('Failed to update status');
    });
}

function updateStatusUI() {
    const toggleBtn = document.getElementById('statusToggle');
    const statusText = document.getElementById('currentStatus');
    
    if (isCurrentlyOnline) {
        toggleBtn.className = 'bg-green-500 text-white px-3 py-1 rounded-full text-sm hover:bg-green-600 transition';
        toggleBtn.textContent = 'üü¢ Go Offline';
        statusText.textContent = 'Status: Online';
        statusText.className = 'ml-2 text-sm text-green-600';
    } else {
        toggleBtn.className = 'bg-gray-500 text-white px-3 py-1 rounded-full text-sm hover:bg-gray-600 transition';
        toggleBtn.textContent = 'üîò Go Online';
        statusText.textContent = 'Status: Offline';
        statusText.className = 'ml-2 text-sm text-red-600';
    }
}

// Check current status when page loads
function checkCurrentStatus() {
    // Set to online by default when viewing the page
    isCurrentlyOnline = false;
    toggleOnlineStatus(); // This will set the user online
}

// Initialize status check
checkCurrentStatus();
</script>

{% endblock %} 