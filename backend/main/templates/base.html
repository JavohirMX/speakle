<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Speakle - Connect, Learn, Speak{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        html { scroll-behavior: smooth; }
        
        /* Global notification styles */
        .notification-badge {
            animation: bounce 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes bounce {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease-in-out;
        }
        
        .notification-toast.show {
            transform: translateX(0);
        }
        
        .call-modal-overlay {
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        .call-modal-content {
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            0% {
                opacity: 0;
                transform: translate(-50%, -40%) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        {% block extra_css %}{% endblock %}
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="{% url 'main:home' %}" class="text-2xl font-bold text-blue-600">
                        üó£Ô∏è Speakle
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    {% if user.is_authenticated %}
                        <a href="{% url 'matches:find_matches' %}" class="text-gray-700 hover:text-blue-600">Find Partners</a>
                        <a href="{% url 'matches:my_matches' %}" class="text-gray-700 hover:text-blue-600 relative">
                            My Matches
                            <span id="pendingCallsBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center notification-badge" style="display: none;"></span>
                        </a>
                        <a href="{% url 'matches:requests' %}" class="text-gray-700 hover:text-blue-600">Requests</a>
                        <a href="{% url 'users:profile' %}" class="text-gray-700 hover:text-blue-600">Profile</a>
                        <a href="{% url 'users:logout' %}" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition">Logout</a>
                    {% else %}
                        <a href="{% url 'users:login' %}" class="text-gray-700 hover:text-blue-600">Login</a>
                        <a href="{% url 'users:register' %}" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">Sign Up</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Global Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <div class="bg-white shadow-lg rounded-lg p-4 max-w-sm border-l-4 border-blue-500">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <span id="toastIcon" class="text-2xl">üìû</span>
                </div>
                <div class="ml-3 flex-1">
                    <p id="toastTitle" class="text-sm font-medium text-gray-900">Notification</p>
                    <p id="toastMessage" class="text-sm text-gray-500 mt-1">Message content</p>
                </div>
                <div class="ml-3">
                    <button onclick="hideNotificationToast()" class="text-gray-400 hover:text-gray-600">
                        <span class="sr-only">Close</span>
                        √ó
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if user.is_authenticated %}
    <!-- Global Incoming Call Modal -->
    <div id="globalIncomingCallModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[9999] call-modal-overlay">
        <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 call-modal-content">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <div class="text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-3xl">üìû</span>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Incoming Video Call</h3>
                    <p class="text-lg font-medium text-gray-800 mb-1" id="globalCallerName"></p>
                    <p class="text-sm text-gray-600 mb-4">wants to start a video call</p>
                    
                    <div id="globalCallerMessage" class="mb-6 p-4 bg-blue-50 rounded-lg text-sm text-gray-700" style="display: none;">
                        <div class="flex items-start">
                            <span class="text-blue-500 mr-2">üí¨</span>
                            <div id="globalMessageContent"></div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="globalDeclineCall()" 
                                class="flex-1 bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition font-medium">
                            ‚ùå Decline
                        </button>
                        <button onclick="globalAcceptCall()" 
                                class="flex-1 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition font-medium">
                            ‚úÖ Accept
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Content -->
    <main>
        {% block content %}
        {% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-20">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <p>&copy; 2025 Speakle. Connect with language learners worldwide.</p>
            </div>
        </div>
    </footer>

    <script>
        // Simple JavaScript for enhanced interactivity
        document.addEventListener('DOMContentLoaded', function() {
            // Add hover effects to language cards
            const languageCards = document.querySelectorAll('.grid .text-center');
            languageCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
        });

        {% if user.is_authenticated %}
        // Global notification system for authenticated users
        let globalNotificationSocket = null;
        let currentGlobalIncomingInvitation = null;
        let pendingCallsCount = 0;
        let browserNotificationsEnabled = false;

        // Request browser notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        browserNotificationsEnabled = true;
                        console.log('Browser notifications enabled');
                    }
                });
            } else if (Notification.permission === 'granted') {
                browserNotificationsEnabled = true;
            }
        }

        // Show browser notification
        function showBrowserNotification(title, message, icon = 'üìû') {
            if (browserNotificationsEnabled && 'Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: message,
                    icon: '/static/favicon.ico', // You can add a favicon later
                    badge: '/static/favicon.ico',
                    requireInteraction: true, // Keep notification until user interacts
                    tag: 'speakle-call' // Replace existing notifications
                });
                
                // Auto-close after 10 seconds
                setTimeout(() => notification.close(), 10000);
                
                return notification;
            }
            return null;
        }

        // Global notification functions
        function showNotificationToast(title, message, icon = 'üìû', duration = 5000) {
            const toast = document.getElementById('notificationToast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            toastIcon.textContent = icon;
            
            toast.classList.add('show');
            
            // Auto-hide after duration
            setTimeout(() => {
                hideNotificationToast();
            }, duration);
        }

        function hideNotificationToast() {
            const toast = document.getElementById('notificationToast');
            toast.classList.remove('show');
        }

        function updatePendingCallsBadge() {
            const badge = document.getElementById('pendingCallsBadge');
            if (pendingCallsCount > 0) {
                badge.textContent = pendingCallsCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function connectGlobalNotificationWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/notifications/`;
            
            globalNotificationSocket = new WebSocket(wsUrl);
            
            globalNotificationSocket.onopen = function() {
                console.log('Global notification WebSocket connected');
                
                // Check for pending invitations on connect
                checkPendingInvitations();
            };
            
            globalNotificationSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleGlobalNotificationMessage(data);
            };
            
            globalNotificationSocket.onclose = function(event) {
                console.log('Global notification WebSocket disconnected, attempting reconnect...', event.code);
                // Attempt to reconnect after 3 seconds, but not if it was a deliberate close
                if (event.code !== 1000) {
                    setTimeout(connectGlobalNotificationWebSocket, 3000);
                }
            };
            
            globalNotificationSocket.onerror = function(error) {
                console.error('Global notification WebSocket error:', error);
            };
        }

        function handleGlobalNotificationMessage(data) {
            console.log('Global notification received:', data);
            
            switch (data.type) {
                case 'notification_connected':
                    console.log('Global notification system connected');
                    break;
                case 'call_invitation_received':
                    handleGlobalIncomingCallInvitation(data);
                    break;
                case 'call_invitation_accepted':
                    showNotificationToast(
                        'Call Accepted!',
                        `${data.accepter_username} accepted your call`,
                        '‚úÖ'
                    );
                    showBrowserNotification(
                        'Call Accepted!',
                        `${data.accepter_username} accepted your call`,
                        '‚úÖ'
                    );
                    // Redirect caller to the video room
                    setTimeout(() => {
                        window.location.href = data.room_url;
                    }, 1500);
                    break;
                case 'call_invitation_declined':
                    showNotificationToast(
                        'Call Declined',
                        `${data.decliner_username} declined your call`,
                        '‚ùå'
                    );
                    showBrowserNotification(
                        'Call Declined',
                        `${data.decliner_username} declined your call`,
                        '‚ùå'
                    );
                    break;
                case 'call_invitation_cancelled':
                    handleGlobalCallCancelled(data);
                    break;
            }
        }

        function handleGlobalIncomingCallInvitation(data) {
            // Show toast notification
            showNotificationToast(
                'Incoming Call',
                `${data.caller_username} wants to video chat`,
                'üìû',
                15000 // Show longer for incoming calls
            );

            // Show browser notification
            const browserNotif = showBrowserNotification(
                'Incoming Video Call',
                `${data.caller_username} wants to start a video call`,
                'üìû'
            );

            // Show incoming call modal
            const invitation = {
                id: data.invitation_id,
                caller: data.caller_username,
                caller_id: data.caller_id,
                message: data.message,
                match_id: data.match_id,
                expires_at: data.expires_at
            };
            showGlobalIncomingCall(invitation);
            
            // Update badge
            pendingCallsCount++;
            updatePendingCallsBadge();

            // Play notification sound (if available)
            try {
                // Create a simple beep sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio notification not available:', e);
            }

            // Handle browser notification click
            if (browserNotif) {
                browserNotif.onclick = function() {
                    window.focus();
                    browserNotif.close();
                    // Focus on the incoming call modal if it's open
                    const modal = document.getElementById('globalIncomingCallModal');
                    if (!modal.classList.contains('hidden')) {
                        modal.scrollIntoView();
                    }
                };
            }
        }

        function handleGlobalCallCancelled(data) {
            // If we have an incoming call modal open for this invitation, close it
            if (currentGlobalIncomingInvitation && currentGlobalIncomingInvitation.id == data.invitation_id) {
                document.getElementById('globalIncomingCallModal').classList.add('hidden');
                currentGlobalIncomingInvitation = null;
                
                // Update badge
                pendingCallsCount = Math.max(0, pendingCallsCount - 1);
                updatePendingCallsBadge();
            }
            
            showNotificationToast(
                'Call Cancelled',
                `${data.canceller_username} cancelled the call`,
                'üö´'
            );
            
            showBrowserNotification(
                'Call Cancelled',
                `${data.canceller_username} cancelled the call`,
                'üö´'
            );
        }

        function showGlobalIncomingCall(invitation) {
            // Only show modal if there's no current incoming call modal open
            if (!currentGlobalIncomingInvitation) {
                currentGlobalIncomingInvitation = invitation;
                document.getElementById('globalCallerName').textContent = invitation.caller;
                
                if (invitation.message && invitation.message.trim()) {
                    document.getElementById('globalMessageContent').textContent = invitation.message;
                    document.getElementById('globalCallerMessage').style.display = 'block';
                } else {
                    document.getElementById('globalCallerMessage').style.display = 'none';
                }
                
                document.getElementById('globalIncomingCallModal').classList.remove('hidden');
            }
        }

        function globalAcceptCall() {
            if (currentGlobalIncomingInvitation) {
                const formData = new FormData();
                formData.append('response', 'accept');
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                
                fetch(`/chats/api/respond-invitation/${currentGlobalIncomingInvitation.id}/`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('globalIncomingCallModal').classList.add('hidden');
                        currentGlobalIncomingInvitation = null;
                        
                        // Update badge
                        pendingCallsCount = Math.max(0, pendingCallsCount - 1);
                        updatePendingCallsBadge();
                        
                        // Redirect to video room
                        showNotificationToast('Joining call...', 'Redirecting to video room', 'üé•');
                        setTimeout(() => {
                            window.location.href = data.room_url;
                        }, 1000);
                    }
                })
                .catch(error => {
                    console.error('Error accepting call:', error);
                    showNotificationToast('Error', 'Failed to accept call', '‚ùå');
                });
            }
        }

        function globalDeclineCall() {
            if (currentGlobalIncomingInvitation) {
                const formData = new FormData();
                formData.append('response', 'decline');
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                
                fetch(`/chats/api/respond-invitation/${currentGlobalIncomingInvitation.id}/`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('globalIncomingCallModal').classList.add('hidden');
                    currentGlobalIncomingInvitation = null;
                    
                    // Update badge
                    pendingCallsCount = Math.max(0, pendingCallsCount - 1);
                    updatePendingCallsBadge();
                    
                    showNotificationToast('Call declined', 'Call invitation declined', '‚ùå');
                })
                .catch(error => {
                    console.error('Error declining call:', error);
                    showNotificationToast('Error', 'Failed to decline call', '‚ùå');
                });
            }
        }

        // Check for pending invitations on page load
        function checkPendingInvitations() {
            fetch('/chats/api/pending-invitations/')
            .then(response => response.json())
            .then(data => {
                if (data.invitations && data.invitations.length > 0) {
                    pendingCallsCount = data.invitations.length;
                    updatePendingCallsBadge();
                    
                    // Show the most recent invitation if no modal is currently open
                    if (!currentGlobalIncomingInvitation) {
                        showGlobalIncomingCall(data.invitations[0]);
                    }
                    
                    // Show toast for multiple pending calls
                    if (data.invitations.length > 1) {
                        showNotificationToast(
                            'Multiple Calls',
                            `You have ${data.invitations.length} pending call invitations`,
                            'üìû'
                        );
                    }
                } else {
                    // Reset badge if no pending calls
                    pendingCallsCount = 0;
                    updatePendingCallsBadge();
                }
            })
            .catch(error => console.error('Error checking invitations:', error));
        }

        // Close modal when clicking outside
        document.getElementById('globalIncomingCallModal').addEventListener('click', function(e) {
            if (e.target === this) {
                globalDeclineCall();
            }
        });

        // Handle page visibility change to reconnect WebSocket if needed
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && (!globalNotificationSocket || globalNotificationSocket.readyState !== WebSocket.OPEN)) {
                console.log('Page visible again, reconnecting WebSocket...');
                connectGlobalNotificationWebSocket();
            }
        });

        // Initialize global notification system when page loads
        requestNotificationPermission();
        connectGlobalNotificationWebSocket();

        // Check for pending invitations periodically (as backup to WebSocket)
        setInterval(checkPendingInvitations, 30000); // Every 30 seconds

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (globalNotificationSocket) {
                globalNotificationSocket.close(1000, 'Page unload');
            }
        });

        // Global function for initiating video calls (to be used across all pages)
        function initiateVideoCallGlobal(matchId, partnerUsername) {
            // Check if partner is available first
            fetch(`/chats/api/partner-availability/${matchId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.is_online) {
                    // Partner is online, show call invitation modal
                    showCallInvitationModal(matchId, partnerUsername);
                } else {
                    // Partner is offline
                    const lastSeen = new Date(data.last_seen).toLocaleString();
                    showNotificationToast(
                        'Partner Offline',
                        `${partnerUsername} was last seen: ${lastSeen}`,
                        'üî¥',
                        8000
                    );
                }
            })
            .catch(error => {
                console.error('Error checking partner availability:', error);
                showNotificationToast('Error', 'Failed to check partner availability', '‚ùå');
            });
        }

        function showCallInvitationModal(matchId, partnerUsername) {
            // Create a simple call invitation modal if it doesn't exist
            let modal = document.getElementById('quickCallModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'quickCallModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden z-[9998] call-modal-overlay';
                modal.innerHTML = `
                    <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 call-modal-content">
                        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                            <div class="text-center">
                                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <span class="text-3xl">üìû</span>
                                </div>
                                <h3 class="text-xl font-semibold text-gray-900 mb-2">Start Video Call</h3>
                                <p class="text-lg font-medium text-gray-800 mb-1" id="quickCallPartner"></p>
                                <p class="text-sm text-gray-600 mb-4">Send a call invitation</p>
                                
                                <div class="mb-6">
                                    <textarea id="quickCallMessage" placeholder="Optional message..." 
                                            class="w-full border border-gray-300 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                            rows="3"></textarea>
                                </div>
                                
                                <div class="flex space-x-4">
                                    <button onclick="closeQuickCallModal()" 
                                            class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition font-medium">
                                        Cancel
                                    </button>
                                    <button onclick="sendQuickCallInvitation()" 
                                            class="flex-1 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition font-medium">
                                        üìû Send Invitation
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeQuickCallModal();
                    }
                });
            }
            
            // Set the partner name and match ID
            document.getElementById('quickCallPartner').textContent = partnerUsername;
            modal.dataset.matchId = matchId;
            modal.classList.remove('hidden');
        }

        function closeQuickCallModal() {
            const modal = document.getElementById('quickCallModal');
            if (modal) {
                modal.classList.add('hidden');
                document.getElementById('quickCallMessage').value = '';
            }
        }

        function sendQuickCallInvitation() {
            const modal = document.getElementById('quickCallModal');
            const matchId = modal.dataset.matchId;
            const message = document.getElementById('quickCallMessage').value;
            
            const formData = new FormData();
            formData.append('message', message);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            fetch(`/chats/api/send-invitation/${matchId}/`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeQuickCallModal();
                    showNotificationToast(
                        'Invitation Sent!',
                        'Waiting for response...',
                        'üìû',
                        5000
                    );
                } else {
                    showNotificationToast('Error', data.error || 'Failed to send invitation', '‚ùå');
                }
            })
            .catch(error => {
                console.error('Error sending invitation:', error);
                showNotificationToast('Error', 'Failed to send invitation', '‚ùå');
            });
        }

        {% endif %}
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html> 